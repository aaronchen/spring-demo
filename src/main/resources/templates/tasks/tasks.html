<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layouts/base :: head('Spring Workshop - Tasks', '/css/tasks.css')}"></head>
<body class="d-flex flex-column min-vh-100">

    <!-- Navigation -->
    <div th:replace="~{layouts/base :: navbar}"></div>

    <!-- Main Content -->
    <main class="container flex-grow-1 pb-4">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="display-4">Tasks</h1>
                    <button class="btn btn-primary btn-lg"
                            hx-get="/web/tasks/new"
                            hx-target="#task-modal-content"
                            hx-swap="innerHTML">
                        <i class="bi bi-plus-circle"></i> New Task
                    </button>
                </div>

                <!-- Row 1: Search -->
                <div class="mb-3">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text"
                               id="search-input"
                               class="form-control"
                               placeholder="Search tasks by title or description...">
                        <input type="hidden" id="current-filter" value="all">
                    </div>
                </div>

                <!-- Row 2: Filter + Sort + View Toggle -->
                <div class="d-flex align-items-center gap-2 mb-4">
                    <!-- Filter Buttons -->
                    <div class="btn-group" role="group" aria-label="Task filters">
                        <button type="button"
                                class="btn btn-outline-light border-secondary text-dark active fw-bold"
                                id="filter-all">
                            <i class="bi bi-list-ul"></i> All
                        </button>
                        <button type="button"
                                class="btn btn-outline-light border-secondary text-success fw-bold"
                                id="filter-completed">
                            <i class="bi bi-check-circle-fill"></i> Completed
                        </button>
                        <button type="button"
                                class="btn btn-outline-light border-secondary text-warning fw-bold"
                                id="filter-incomplete">
                            <i class="bi bi-circle"></i> Pending
                        </button>
                    </div>

                    <!-- Sort Dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle"
                                type="button"
                                id="sortDropdown"
                                data-bs-toggle="dropdown"
                                data-bs-auto-close="outside"
                                aria-expanded="false">
                            <i class="bi bi-sort-down"></i> <span id="sort-label">Newest First</span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="title" data-sort-dir="asc"
                                   onclick="toggleSort('title','asc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-alpha-down"></i> Title (A-Z)
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="title" data-sort-dir="desc"
                                   onclick="toggleSort('title','desc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-alpha-up"></i> Title (Z-A)
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="createdAt" data-sort-dir="asc"
                                   onclick="toggleSort('createdAt','asc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-numeric-down"></i> Oldest First
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="createdAt" data-sort-dir="desc"
                                   onclick="toggleSort('createdAt','desc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-numeric-up"></i> Newest First
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="description" data-sort-dir="asc"
                                   onclick="toggleSort('description','asc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-alpha-down"></i> Description (A-Z)
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="description" data-sort-dir="desc"
                                   onclick="toggleSort('description','desc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-alpha-up"></i> Description (Z-A)
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   onclick="resetSort(); return false;">
                                    <i class="bi bi-check-lg" style="visibility: hidden;"></i>
                                    <i class="bi bi-arrow-counterclockwise"></i> Default
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- View Toggle -->
                    <div class="btn-group ms-auto" role="group" aria-label="View toggle">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                id="view-cards"
                                onclick="switchView('cards')">
                            <i class="bi bi-grid-3x3-gap-fill"></i>
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary"
                                id="view-table"
                                onclick="switchView('table')">
                            <i class="bi bi-table"></i>
                        </button>
                    </div>

                </div>

                <!-- Task List Container (targeted by HTMX) -->
                <div id="tasks-view">
                    <th:block th:if="${view == 'table'}">
                        <div th:replace="~{tasks/task-table :: grid}"></div>
                    </th:block>
                    <th:block th:if="${view != 'table'}">
                        <div th:replace="~{tasks/task-cards :: grid}"></div>
                    </th:block>
                </div>
            </div>
        </div>
    </main>

    <!-- Shared New/Edit Task Modal (content loaded by HTMX) -->
    <div class="modal fade" id="task-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" id="task-modal-content">
                <!-- Populated by hx-get on New Task and Edit buttons -->
            </div>
        </div>
    </div>

    <!-- Shared Delete Confirmation Modal -->
    <div class="modal fade" id="task-delete-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Confirm Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this task?</p>
                    <p id="task-delete-modal-title" class="fw-bold"></p>
                    <p class="text-muted small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button id="delete-confirm-btn" class="btn btn-danger" hx-swap="none" data-bs-dismiss="modal">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div th:replace="~{layouts/base :: footer}"></div>

    <!-- Scripts -->
    <div th:replace="~{layouts/base :: scripts}"></div>

    <script th:src="@{/js/tasks.js}"></script>
</body>
</html>
