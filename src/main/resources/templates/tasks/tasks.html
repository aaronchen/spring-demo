<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layouts/base :: head('Task Manager - All Tasks')}"></head>
<body class="d-flex flex-column min-vh-100">

    <!-- Navigation -->
    <div th:replace="~{layouts/base :: navbar}"></div>

    <!-- Main Content -->
    <main class="container flex-grow-1 pb-4">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="display-4">Tasks</h1>
                    <a th:href="@{/web/tasks/new}" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle"></i> New Task
                    </a>
                </div>

                <!-- Row 1: Search -->
                <div class="mb-3">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text"
                               id="search-input"
                               class="form-control"
                               placeholder="Search tasks by title or description...">
                        <input type="hidden" id="current-filter" value="all">
                    </div>
                </div>

                <!-- Row 2: Filter + Sort + View Toggle -->
                <div class="d-flex align-items-center gap-2 mb-4">
                    <!-- Filter Buttons -->
                    <div class="btn-group" role="group" aria-label="Task filters">
                        <button type="button"
                                class="btn btn-outline-light border-secondary text-dark active fw-bold"
                                id="filter-all">
                            <i class="bi bi-list-ul"></i> All
                        </button>
                        <button type="button"
                                class="btn btn-outline-light border-secondary text-success fw-bold"
                                id="filter-completed">
                            <i class="bi bi-check-circle-fill"></i> Completed
                        </button>
                        <button type="button"
                                class="btn btn-outline-light border-secondary text-warning fw-bold"
                                id="filter-incomplete">
                            <i class="bi bi-circle"></i> Pending
                        </button>
                    </div>

                    <!-- Sort Dropdown -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle"
                                type="button"
                                id="sortDropdown"
                                data-bs-toggle="dropdown"
                                data-bs-auto-close="outside"
                                aria-expanded="false">
                            <i class="bi bi-sort-down"></i> <span id="sort-label">Newest First</span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="title" data-sort-dir="asc"
                                   onclick="toggleSort('title','asc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-alpha-down"></i> Title (A-Z)
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="title" data-sort-dir="desc"
                                   onclick="toggleSort('title','desc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-alpha-up"></i> Title (Z-A)
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="createdAt" data-sort-dir="asc"
                                   onclick="toggleSort('createdAt','asc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-numeric-down"></i> Oldest First
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="createdAt" data-sort-dir="desc"
                                   onclick="toggleSort('createdAt','desc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-numeric-up"></i> Newest First
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="description" data-sort-dir="asc"
                                   onclick="toggleSort('description','asc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-alpha-down"></i> Description (A-Z)
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   data-sort-field="description" data-sort-dir="desc"
                                   onclick="toggleSort('description','desc'); return false;">
                                    <i class="bi bi-check-lg sort-check"></i>
                                    <i class="bi bi-sort-alpha-up"></i> Description (Z-A)
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="#"
                                   onclick="resetSort(); return false;">
                                    <i class="bi bi-check-lg" style="visibility: hidden;"></i>
                                    <i class="bi bi-arrow-counterclockwise"></i> Default
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- View Toggle -->
                    <div class="btn-group ms-auto" role="group" aria-label="View toggle">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                id="view-cards"
                                onclick="switchView('cards')">
                            <i class="bi bi-grid-3x3-gap-fill"></i>
                        </button>
                        <button type="button"
                                class="btn btn-outline-secondary"
                                id="view-table"
                                onclick="switchView('table')">
                            <i class="bi bi-table"></i>
                        </button>
                    </div>

                </div>

                <!-- Task List Container (targeted by HTMX) -->
                <div id="tasks-view">
                    <th:block th:if="${view == 'table'}">
                        <div th:replace="~{tasks/task-table :: grid}"></div>
                    </th:block>
                    <th:block th:if="${view != 'table'}">
                        <div th:replace="~{tasks/task-cards :: grid}"></div>
                    </th:block>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div th:replace="~{layouts/base :: footer}"></div>

    <!-- Scripts -->
    <div th:replace="~{layouts/base :: scripts}"></div>

    <!-- Sort, filter, search, and pagination state management -->
    <script>
        const SORT_LABELS = {
            'title,asc':        'Title ↑',
            'title,desc':       'Title ↓',
            'createdAt,asc':    'Oldest First',
            'createdAt,desc':   'Newest First',
            'description,asc':  'Desc ↑',
            'description,desc': 'Desc ↓',
        };

        let activeSorts = [{field: 'createdAt', direction: 'desc'}];
        let currentPage = 0;
        let pageSize = parseInt(getCookie('pageSize') || '25');
        let currentView = 'cards';

        // Read a cookie by name
        function getCookie(name) {
            const match = document.cookie.match(new RegExp('(?:^|;\\s*)' + name + '=([^;]*)'));
            return match ? match[1] : null;
        }

        // Write a persistent cookie (1 year)
        function setCookie(name, value) {
            document.cookie = `${name}=${value}; path=/; max-age=31536000`;
        }

        // Build the URL for the current state
        function buildUrl(page) {
            const params = new URLSearchParams();
            const search = document.getElementById('search-input').value;
            const filter = document.getElementById('current-filter').value;
            if (search) params.set('search', search);
            if (filter && filter !== 'all') params.set('filter', filter);
            activeSorts.forEach(s => params.append('sort', `${s.field},${s.direction}`));
            params.set('size', pageSize);
            if (page > 0) params.set('page', page);
            if (currentView !== 'cards') params.set('view', currentView);
            return `/web/tasks?${params.toString()}`;
        }

        // Fetch grid fragment via HTMX and update the URL (replaces history — no back entry)
        function doSearch(resetPage) {
            if (resetPage) currentPage = 0;
            const url = buildUrl(currentPage);
            htmx.ajax('GET', url, {target: '#tasks-view', swap: 'innerHTML'});
            window.history.replaceState({}, '', url);
        }

        // Navigate to a specific page (pushes history — back/forward works)
        function navigateToPage(page) {
            if (page < 0) return;
            currentPage = page;
            const url = buildUrl(page);
            htmx.ajax('GET', url, {target: '#tasks-view', swap: 'innerHTML'});
            window.history.pushState({}, '', url);
        }

        // Switch between card and table views
        function switchView(view) {
            currentView = view;
            setCookie('view', view);
            renderViewToggle();
            doSearch(false);
        }

        // Update active state on view toggle buttons
        function renderViewToggle() {
            document.getElementById('view-cards').classList.toggle('active', currentView === 'cards');
            document.getElementById('view-table').classList.toggle('active', currentView === 'table');
        }

        // Per-page selector change — syncs all instances (top and bottom bars)
        function onPageSizeChange(newSize) {
            pageSize = parseInt(newSize);
            setCookie('pageSize', pageSize);
            syncPageSizeSelects();
            currentPage = 0;
            doSearch(false);
        }

        function syncPageSizeSelects() {
            document.querySelectorAll('.page-size-select').forEach(el => el.value = pageSize);
        }

        // Reset sort to default (newest first)
        function resetSort() {
            activeSorts = [{field: 'createdAt', direction: 'desc'}];
            renderSorts();
            doSearch(true);
        }

        // Toggle a sort option (mutual exclusion within same field)
        function toggleSort(field, direction) {
            const idx = activeSorts.findIndex(s => s.field === field && s.direction === direction);
            if (idx >= 0) {
                if (activeSorts.length === 1) return; // Keep at least one sort active
                activeSorts.splice(idx, 1);
            } else {
                // Remove the opposite direction for this field
                const oppositeIdx = activeSorts.findIndex(s => s.field === field);
                if (oppositeIdx >= 0) activeSorts.splice(oppositeIdx, 1);
                activeSorts.push({field, direction});
            }
            renderSorts();
            doSearch(true);
        }

        // Update sort button label and checkmarks
        function renderSorts() {
            const label = activeSorts
                .map(s => SORT_LABELS[`${s.field},${s.direction}`] || `${s.field} ${s.direction}`)
                .join(', ');
            document.getElementById('sort-label').textContent = label;

            document.querySelectorAll('[data-sort-field]').forEach(item => {
                const check = item.querySelector('.sort-check');
                const isActive = activeSorts.some(
                    s => s.field === item.dataset.sortField && s.direction === item.dataset.sortDir
                );
                if (check) check.style.visibility = isActive ? 'visible' : 'hidden';
            });
        }

        // Read URL params and sync all UI state
        function initFromUrl() {
            const params = new URLSearchParams(window.location.search);

            // Sort
            const sortParams = params.getAll('sort');
            if (sortParams.length > 0) {
                activeSorts = sortParams.map(s => {
                    const parts = s.split(',');
                    return {field: parts[0], direction: parts[1] || 'desc'};
                });
            }

            // Page
            currentPage = parseInt(params.get('page') || '0');

            // Size (URL takes precedence over cookie)
            if (params.has('size')) {
                pageSize = parseInt(params.get('size'));
                setCookie('pageSize', pageSize);
            }
            syncPageSizeSelects();

            // Filter
            const filter = params.get('filter') || 'all';
            document.getElementById('current-filter').value = filter;
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.toggle('active', btn.id === 'filter-' + filter);
            });

            // Search
            document.getElementById('search-input').value = params.get('search') || '';

            // View: URL takes precedence; fall back to cookie (mirrors server-side logic)
            currentView = params.get('view') || getCookie('view') || 'cards';
            renderViewToggle();

            // Render sort checkmarks and label
            renderSorts();
        }

        document.addEventListener('DOMContentLoaded', function() {
            initFromUrl();

            // Debounced live search
            let searchDebounce;
            document.getElementById('search-input').addEventListener('input', function() {
                clearTimeout(searchDebounce);
                searchDebounce = setTimeout(() => doSearch(true), 300);
            });

            // Filter button click handlers
            document.querySelectorAll('[id^="filter-"]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('[id^="filter-"]').forEach(btn =>
                        btn.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('current-filter').value =
                        this.id.replace('filter-', '');
                    doSearch(true);
                });
            });

            // After HTMX replaces the grid, re-sync the per-page selects in the new HTML
            document.addEventListener('htmx:afterSwap', function(evt) {
                if (evt.detail.target && evt.detail.target.id === 'tasks-view') {
                    syncPageSizeSelects();
                }
            });

            // Table view: after a delete, refresh the grid (hx-swap="none" so grid doesn't auto-update)
            document.addEventListener('htmx:afterRequest', function(evt) {
                if (evt.target.classList.contains('table-delete-confirm') && evt.detail.successful) {
                    doSearch(false);
                }
            });

            // Handle browser back/forward — re-sync state from URL and re-fetch the grid
            window.addEventListener('popstate', function() {
                initFromUrl();
                doSearch(false);
            });
        });
    </script>
</body>
</html>
